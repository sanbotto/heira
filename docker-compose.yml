services:
  backend:
    # Use pre-built image from GitHub Container Registry
    image: ghcr.io/sanbotto/heira/backend:latest
    container_name: heira-backend

    ports:
      - "${HOST_PORT:-80}:3001"
    environment:
      # Server Configuration
      PORT: 3001

      # Private key for signing transactions
      PRIVATE_KEY: ${PRIVATE_KEY}

      # Enable keeper service
      ENABLE_KEEPER: ${ENABLE_KEEPER:-true}

      # Keeper Configuration - Factory Addresses
      FACTORY_ADDRESS_ETHEREUM: ${FACTORY_ADDRESS_ETHEREUM:-}
      FACTORY_ADDRESS_BASE: ${FACTORY_ADDRESS_BASE:-}
      FACTORY_ADDRESS_CITREA: ${FACTORY_ADDRESS_CITREA:-}
      KEEPER_CHECK_INTERVAL_MS: ${KEEPER_CHECK_INTERVAL_MS:-300000}

      # RPC URLs for contract verification and keeper service
      SEPOLIA_RPC_URL: ${SEPOLIA_RPC_URL:-https://rpc.sepolia.org}
      BASE_SEPOLIA_RPC_URL: ${BASE_SEPOLIA_RPC_URL:-https://sepolia.base.org}
      MAINNET_RPC_URL: ${MAINNET_RPC_URL:-https://eth.llamarpc.com}
      BASE_RPC_URL: ${BASE_RPC_URL:-https://mainnet.base.org}
      CITREA_RPC_URL: ${CITREA_RPC_URL:-https://rpc.testnet.citrea.xyz}

      # API Keys
      ETHERSCAN_API_KEY: ${ETHERSCAN_API_KEY}
      1INCH_API_KEY: ${1INCH_API_KEY:-}

      # MailPace Configuration (for email notifications)
      MAILPACE_API_TOKEN: ${MAILPACE_API_TOKEN:-}
      MAILPACE_FROM_EMAIL: ${MAILPACE_FROM_EMAIL:-noreply@heira.app}
    env_file:
      - ./backend/.env
    volumes:
      # Persist escrow storage data
      - ./backend/data:/app/data
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - heira-network

networks:
  heira-network:
    driver: bridge
